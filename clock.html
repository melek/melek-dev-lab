<!DOCTYPE html>
<html>
<head>
<title>Simple Timer</title>
<meta charset="utf-8">
<style>
:root {
	--bg-fallback: rgb(38,70,83);
	--bg: linear-gradient(0deg, rgba(38,70,83,1) 0%, rgba(42,157,143,1) 50%);
	--textColor: white;
	--clockTextColor: white;	
	--control-Secondary: rgba(128,196,152, .5);
	--control-Primary: rgba(255, 161, 122, .5);
	--control-Good: rgba(182, 243, 156, .5); 
	--control-Bad: rgb(160, 40, 40, .5); 
}

body { 
	margin:0;
	padding: 0;
	background: var(--bg-fallback);	
	background: linear-gradient(0deg, rgba(38,70,83,1) 0%, rgba(42,157,143,1) 50%);
	color: var(--textColor);
}

#timer {
	padding: 0;
	margin: 0;
	height: 100%;
	min-height: 100vh;
	min-width: 100vw;
	display: flex;
	align-items: center;
	justify-content: center;
	flex-direction: column;
	gap: .5rem;
}

#timer > div {
	text-align: center;
	min-width: 50vmin;
	max-width: 95vmin;
}

#mainClock {
	font-size: 25vmin;
}

.clock { 
	font-family: monospace;
	color: var(--clockTextColor);
}

#extraClocks {
	display: flex;
	font-size: 1rem;
	justify-content: space-evenly;
	gap: 5rem;
}

#controls {
	display: flex;
	gap: .5rem;
	justify-content: center;
}

.control {
	border-radius: 3px;
	background: var(--control-Secondary);
	padding: .5rem;
	text-align: center;
	cursor: pointer;
	flex-grow: 1;
}

#resets {
	margin-top: .5rem;
	display: flex;
	gap: .5rem;
	flex-wrap: wrap;
}

.reset-dot {
	border-radius:50%;
	background-color: var(--control-Secondary);
	width: 1.5rem;
	height: 1.5rem;
}

.delay { background-color: var(--control-Seconder); }
.done {	background-color: var(--control-Good); }
.expire { background-color: var(--control-Bad); }
.pause { background-color: var(--control-Primary); }

.paused {
  animation: blinker 2s linear infinite;
}

@keyframes blinker {
  50% {
    opacity: 20%;
  }
}

</style>
</head>
<body><div id="timer">
	<div id="mainClock" class="clock paused">15:00</div>
	<div id="extraClocks">
		<div>Shift: <span id="shiftClock" class="clock paused">1:00</span></div>
		<div>Elapsed: <span id="elapsedClock" class="clock paused">0:00</span></div>
	</div>
	<div id="controls">
		<div id="pause" class="control pause" onClick="togglePause()">Start</div>		
		<div class="control done" onClick="addTime(15, 1)">Ticket (+15m)</div>			
			<div class="control done" onClick="addTime(0, 1)">Chat</div>
		<div style="display:flex; flex-direction: column; gap: 5px;">
			<div class="control" onClick="addShiftTime(15)">+Shift</div>
			<div class="control" onClick="addShiftTime(-15)">-Shift</div>			
		</div>
		<div class="control" onClick="resetTimer()">Clr</div>
	</div>
	<div id="resets"></div>
</div>
<script>
const defaultTimerLength = 15 * 60; // 15 minutes default
const defaultShiftLength = 60 * 60; // 15 minutes default

let defaultState = {
	"count": 		defaultTimerLength, 
	"pause": 		true,
	"allpause": 	true,
	"shiftTime":	defaultShiftLength,
	"elapsed":		0
};

let state = Object.assign({}, defaultState);

function newDot(cssClass = "") {
	return `<div class='reset-dot ${cssClass}'></div>`;
}

function resetTimer() {
	if (typeof(Storage) !== "undefined") window.localStorage.clear();
	state = Object.assign({}, defaultState);
	document.getElementById("resets").innerHTML = "";
	setPauseDisplay(0);
	refreshClock();
}

function saveState() {
	if (typeof(Storage) !== "undefined") {
		window.localStorage.setItem('state', JSON.stringify(state));
		window.localStorage.setItem('timerHTML', document.getElementById("timer").innerHTML);		
    }
}

function recoverState() {
	if (typeof(Storage) !== "undefined") {
		if(window.localStorage.getItem("state") != null) {
			state = JSON.parse(window.localStorage.getItem("state"));
		}		
		let storedDots = window.localStorage.getItem("timerHTML");
		if(storedDots != null) document.getElementById("timer").innerHTML = storedDots;
		setPauseDisplay(0);
		refreshClock();
    }
}

function formatTime(secTotal, forceHours = 0, showSeconds = 1) {
	let hr = Math.floor(secTotal / 3600);
    if(hr < 1 && !forceHours) { hr = "" } else { hr = hr + ":"; }

	let min = Math.floor(secTotal / 60) % 60;
    if(min < 10) { min = "0" + min; }

	let sec = "";
	if(showSeconds) {
		sec = secTotal % 60;
		if(sec < 10) sec = "0" + sec;
		sec = ":" + sec;
	}

    return `${hr}${min}${sec}`;
}

function refreshClock() {
    document.getElementById("mainClock").innerHTML = formatTime(Math.min(state.count, state.shiftTime));
	document.getElementById("shiftClock").innerHTML = formatTime(state.shiftTime, 1, 0);
	document.getElementById("elapsedClock").innerHTML = formatTime(state.elapsed, 1, 0);
	saveState();
}

function addTime(minutes, color = "") {
	state.count += minutes * 60;
	document.getElementById("resets").innerHTML += newDot(color);
	refreshClock();
}

function addShiftTime(minutes) {
	state.shiftTime += minutes * 60;
	refreshClock();
}

function setPauseDisplay(setDot = 1) {
	if(state.pause) {
		document.getElementById("mainClock").classList.add("paused");
		if(setDot) document.getElementById("resets").innerHTML += newDot("pause");
		document.getElementById("pause").innerHTML = "Start";
	} else {
		document.getElementById("mainClock").classList.remove("paused");
		document.getElementById("pause").innerHTML = "Pause";
	}
}

function togglePause() {
	state.pause = !state.pause;
	state.allpause = 0;
	setPauseDisplay();
	refreshClock();
}

document.addEventListener('DOMContentLoaded', function() {
    recoverState();
}, false);

// Assign a timed event to variable timerId.
const timerId = setInterval(() => {
	if (state.count > 0 && !state.pause) {
		// Decrement the count variable by one.
		state.count--;		
		if(state.count == 0) addTime(5, "expire");
	}
	if (!state.allpause) {
		if(state.shiftTime > 0) state.shiftTime--;
		state.elapsed++;
	}
	refreshClock();

}, 1000); // Execute event every second (1000 milliseconds = 1 second).
</script></body>
</html>
